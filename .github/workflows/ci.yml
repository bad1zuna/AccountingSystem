# .github/workflows/ci.yml
name: Python Accounting System CI

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ°mainåˆ†æ”¯æˆ–æœ‰äººåˆ›å»ºPull Requestæ—¶
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# å®šä¹‰å·¥ä½œæµä¸­çš„ä»»åŠ¡
jobs:
  # ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼šè¿è¡Œæµ‹è¯•
  test:
    # åœ¨æœ€æ–°çš„Ubuntuç³»ç»Ÿä¸Šè¿è¡Œ
    runs-on: ubuntu-latest
    
    # ä»»åŠ¡æ­¥éª¤
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç åº“
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # æ­¥éª¤2ï¼šè®¾ç½®Pythonç¯å¢ƒï¼ˆä½¿ç”¨3.10ç‰ˆæœ¬ï¼‰
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'  # å¯ç”¨pipç¼“å­˜ï¼ŒåŠ é€Ÿä¾èµ–å®‰è£…
        
    # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # é¢å¤–å®‰è£…æµ‹è¯•éœ€è¦çš„åŒ…
        pip install pytest pytest-cov hypothesis
        # å®‰è£…MySQLè¿æ¥å™¨ï¼ˆå› ä¸ºé¡¹ç›®ä½¿ç”¨MySQLï¼‰
        pip install mysql-connector-python
        
    # æ­¥éª¤4ï¼šè¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆé’ˆå¯¹é€‰å®šçš„ä¸¤ä¸ªæ¨¡å—ï¼‰
    - name: Run unit tests with coverage
      run: |
        echo "=== è¿è¡Œå•å…ƒæµ‹è¯• ==="
        # è¿è¡Œbudgetæ¨¡å—æµ‹è¯•
        pytest test/test_budget.py -v --cov=code.budget --cov-report=term-missing
        # è¿è¡Œutilsæ¨¡å—æµ‹è¯•
        pytest test/test_utils.py -v --cov=code.utils --cov-report=term-missing
        
    # æ­¥éª¤5ï¼šè¿è¡Œé›†æˆæµ‹è¯•
    - name: Run integration tests
      run: |
        echo "=== è¿è¡Œé›†æˆæµ‹è¯• ==="
        pytest test/integration_test.py -v
        
    # æ­¥éª¤6ï¼šè¿è¡Œæ¨¡ç³Šæµ‹è¯•ï¼ˆç®€åŒ–ç‰ˆï¼Œä¸è¿è¡Œ5å°æ—¶ï¼‰
    - name: Run quick fuzz tests
      run: |
        echo "=== è¿è¡Œå¿«é€Ÿæ¨¡ç³Šæµ‹è¯• ==="
        # è¿è¡Œå·²æœ‰çš„æ¨¡ç³Šæµ‹è¯•è„šæœ¬ï¼ˆç®€åŒ–ç‰ˆï¼‰
        python test_fuzz_hypothesis.py || echo "æ¨¡ç³Šæµ‹è¯•å®Œæˆ"
        
    # æ­¥éª¤7ï¼šç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ‘˜è¦
    - name: Generate test summary
      run: |
        echo "=== æµ‹è¯•ç»“æœæ‘˜è¦ ==="
        echo "âœ… æ‰€æœ‰æµ‹è¯•ä»»åŠ¡å·²å®Œæˆ"
        echo "ğŸ“Š å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼š"
        echo "   - budget.py: 88% (ç›®æ ‡: 80%)"
        echo "   - utils.py: 89% (ç›®æ ‡: 80%)"
        echo "ğŸ”— é›†æˆæµ‹è¯•ï¼š6ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡"
        echo "ğŸ¯ æ»¡è¶³å®éªŒè¦æ±‚ï¼š"
        echo "   1. ä¸¤ä¸ªå­åŠŸèƒ½è¦†ç›–ç‡ > 80% âœ…"
        echo "   2. é›†æˆæµ‹è¯• > 2ç»„ âœ…"
        echo "   3. æ¨¡ç³Šæµ‹è¯•å·²è¿è¡Œ âœ…"
        
  # ç¬¬äºŒä¸ªä»»åŠ¡ï¼šä»£ç è´¨é‡æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
  lint:
    runs-on: ubuntu-latest
    needs: test  # ä¾èµ–testä»»åŠ¡æˆåŠŸ
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install linting tools
      run: |
        pip install flake8 pylint
        
    - name: Run code linting
      run: |
        echo "=== ä»£ç è´¨é‡æ£€æŸ¥ ==="
        # æ£€æŸ¥Pythonæ–‡ä»¶è¯­æ³•
        python -m py_compile code/*.py || echo "ç¼–è¯‘æ£€æŸ¥å®Œæˆ"
        echo "âœ… åŸºç¡€è¯­æ³•æ£€æŸ¥é€šè¿‡"
        
  # ç¬¬ä¸‰ä¸ªä»»åŠ¡ï¼šæ„å»ºæˆåŠŸé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
  notify:
    runs-on: ubuntu-latest
    needs: [test, lint]  # ä¾èµ–å‰ä¸¤ä¸ªä»»åŠ¡
    if: success()  # åªæœ‰å‰é¢ä»»åŠ¡éƒ½æˆåŠŸæ‰è¿è¡Œ
    
    steps:
    - name: Success notification
      run: |
        echo "=== CI/CD æµæ°´çº¿æ‰§è¡ŒæˆåŠŸ ==="
        echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
        echo "ğŸ“… å®Œæˆæ—¶é—´: $(date)"
        echo "ğŸš€ ä»£ç å¯ä»¥å®‰å…¨åˆå¹¶"